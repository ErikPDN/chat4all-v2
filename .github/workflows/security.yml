---
name: Security Scanning

'on':
  push:
    branches: [main, develop, feature/**]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security scans weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  dependency-check:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: OWASP Dependency Check
        run: |
          mvn org.owasp:dependency-check-maven:check \
            -DskipTests \
            -Dformat=ALL \
            -DfailBuildOnCVSS=7 \
            -DsuppressionFiles=.github/security/dependency-check-suppressions.xml
        continue-on-error: true

      - name: Upload Dependency Check Report
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: dependency-check-report
          path: |
            **/target/dependency-check-report.html
            **/target/dependency-check-report.json
          retention-days: 30

      - name: Check for Critical Vulnerabilities
        run: |
          if [ -f target/dependency-check-report.json ]; then
            CRITICAL=$(jq '.dependencies[] | \
              select(.vulnerabilities[]?.severity == "CRITICAL") | \
              length' target/dependency-check-report.json | wc -l)
            if [ "$CRITICAL" -gt 0 ]; then
              echo "âŒ Found $CRITICAL critical vulnerabilities!"
              exit 1
            fi
          fi

  snyk-scan:
    name: Snyk Security Scan
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/maven@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --all-projects

      - name: Upload Snyk results to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk.sarif

  trivy-container-scan:
    name: Container Image Scan (Trivy)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - api-gateway
          - message-service
          - user-service
          - file-service
          - router-service
          - whatsapp-connector
          - telegram-connector
          - instagram-connector

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build service
        run: |
          mvn clean package -DskipTests \
            -pl services/${{ matrix.service }} -am

      - name: Build Docker image
        run: |
          docker build -t chat4all-${{ matrix.service }}:latest \
            -f services/${{ matrix.service }}/Dockerfile \
            services/${{ matrix.service }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'chat4all-${{ matrix.service }}:latest'
          format: 'sarif'
          output: 'trivy-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-${{ matrix.service }}.sarif'
          category: 'trivy-${{ matrix.service }}'

      - name: Generate Trivy HTML report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'chat4all-${{ matrix.service }}:latest'
          format: 'template'
          template: '@/contrib/html.tpl'
          output: 'trivy-${{ matrix.service }}.html'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy HTML report
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: trivy-report-${{ matrix.service }}
          path: trivy-${{ matrix.service }}.html
          retention-days: 30

  docker-secrets-scan:
    name: Scan for Secrets in Docker Images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Scan Dockerfiles for hardcoded secrets
        run: |
          echo "Scanning Dockerfiles for potential secrets..."
          find . -name "Dockerfile" -o -name "docker-compose.yml" | \
          while read file; do
            echo "Checking $file..."
            if grep -iE "(password|secret|key|token).*=" "$file"; then
              echo "âš ï¸ Warning: Potential secret in $file"
            fi
          done

  dependabot-auto-merge:
    name: Auto-approve Dependabot PRs
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    needs: [dependency-check]

    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Auto-approve minor and patch updates
        if: >-
          steps.metadata.outputs.update-type ==
            'version-update:semver-patch' ||
          steps.metadata.outputs.update-type ==
            'version-update:semver-minor'
        run: |
          gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on major updates
        if: >-
          steps.metadata.outputs.update-type ==
            'version-update:semver-major'
        run: |
          gh pr comment "$PR_URL" \
            --body "âš ï¸ Major version update. Manual review required."
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [dependency-check, trivy-container-scan, docker-secrets-scan]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate security summary
        run: |
          echo "# ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date**: $(date -u +"%Y-%m-%d %H:%M UTC")" \
            >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Scans Executed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… OWASP Dependency Check" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Trivy Container Scan (8 services)" \
            >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Gitleaks Secret Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "View detailed reports in workflow artifacts." \
            >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review vulnerability reports in artifacts" \
            >> $GITHUB_STEP_SUMMARY
          echo "2. Update dependencies with known vulnerabilities" \
            >> $GITHUB_STEP_SUMMARY
          echo "3. Check GitHub Security tab for detailed findings" \
            >> $GITHUB_STEP_SUMMARY
