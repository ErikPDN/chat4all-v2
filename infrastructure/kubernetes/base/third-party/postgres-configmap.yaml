apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init
  labels:
    app: postgres
    component: database
data:
  init.sql: |
    -- Users table
    CREATE TABLE IF NOT EXISTS users (
        user_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        display_name VARCHAR(255) NOT NULL,
        user_type VARCHAR(50) NOT NULL,
        metadata JSONB,
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
    );
    
    -- External identities table
    CREATE TABLE IF NOT EXISTS external_identities (
        identity_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
        platform VARCHAR(50) NOT NULL,
        platform_user_id VARCHAR(255) NOT NULL,
        verified BOOLEAN DEFAULT false,
        linked_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        UNIQUE(platform, platform_user_id)
    );
    
    -- Audit logs table
    CREATE TABLE IF NOT EXISTS audit_logs (
        log_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        user_id UUID REFERENCES users(user_id),
        action VARCHAR(100) NOT NULL,
        resource_type VARCHAR(100),
        resource_id VARCHAR(255),
        details JSONB,
        ip_address VARCHAR(45),
        created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
    );
    
    -- Create indexes
    CREATE INDEX IF NOT EXISTS idx_external_identities_user_id ON external_identities(user_id);
    CREATE INDEX IF NOT EXISTS idx_external_identities_platform ON external_identities(platform);
    CREATE INDEX IF NOT EXISTS idx_audit_logs_user_id ON audit_logs(user_id);
    CREATE INDEX IF NOT EXISTS idx_audit_logs_created_at ON audit_logs(created_at);
    
    -- Insert sample data (for development)
    INSERT INTO users (user_id, display_name, user_type, metadata)
    VALUES 
        ('00000000-0000-0000-0000-000000000001', 'Admin User', 'AGENT', '{"role": "admin"}'::jsonb),
        ('00000000-0000-0000-0000-000000000002', 'Test Customer', 'CUSTOMER', '{"source": "whatsapp"}'::jsonb)
    ON CONFLICT DO NOTHING;
