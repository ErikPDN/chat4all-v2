apiVersion: v1
kind: ConfigMap
metadata:
  name: mongodb-init
  labels:
    app: mongodb
    component: database
data:
  mongo-init.js: |
    db = db.getSiblingDB('chat4all');
    
    // Create collections
    db.createCollection('messages');
    db.createCollection('conversations');
    db.createCollection('files');
    
    // Create indexes for messages
    db.messages.createIndex({ "messageId": 1 }, { unique: true });
    db.messages.createIndex({ "conversationId": 1, "timestamp": -1 });
    db.messages.createIndex({ "senderId": 1 });
    db.messages.createIndex({ "status": 1 });
    
    // Create indexes for conversations
    db.conversations.createIndex({ "conversationId": 1 }, { unique: true });
    db.conversations.createIndex({ "participantIds": 1 });
    db.conversations.createIndex({ "lastActivityAt": -1 });
    
    // Create indexes for files
    db.files.createIndex({ "fileId": 1 }, { unique: true });
    db.files.createIndex({ "messageId": 1 });
    db.files.createIndex({ "uploadedAt": -1 });
    db.files.createIndex({ "expiresAt": 1 }, { expireAfterSeconds: 0 });
    
    print('MongoDB initialization completed successfully');
