---
# Allow Message Service communication
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-message-service
  labels:
    app.kubernetes.io/platform: chat4all
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app: message-service
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from api-gateway
    - from:
        - podSelector:
            matchLabels:
              app: api-gateway
      ports:
        - protocol: TCP
          port: 8081
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53
    
    # Allow to MongoDB
    - to:
        - podSelector:
            matchLabels:
              app: mongodb
      ports:
        - protocol: TCP
          port: 27017
    
    # Allow to Redis
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379
    
    # Allow to Kafka
    - to:
        - podSelector:
            matchLabels:
              app: kafka
      ports:
        - protocol: TCP
          port: 9092

---
# Allow Router Service communication
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-router-service
  labels:
    app.kubernetes.io/platform: chat4all
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app: router-service
  policyTypes:
    - Ingress
    - Egress
  ingress: []  # Router service doesn't receive HTTP traffic (Kafka consumer only)
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53
    
    # Allow to Kafka
    - to:
        - podSelector:
            matchLabels:
              app: kafka
      ports:
        - protocol: TCP
          port: 9092
    
    # Allow to User Service
    - to:
        - podSelector:
            matchLabels:
              app: user-service
      ports:
        - protocol: TCP
          port: 8083
    
    # Allow to Connectors
    - to:
        - podSelector:
            matchLabels:
              app: whatsapp-connector
      ports:
        - protocol: TCP
          port: 8091
    - to:
        - podSelector:
            matchLabels:
              app: telegram-connector
      ports:
        - protocol: TCP
          port: 8092
    - to:
        - podSelector:
            matchLabels:
              app: instagram-connector
      ports:
        - protocol: TCP
          port: 8093

---
# Allow User Service communication
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-user-service
  labels:
    app.kubernetes.io/platform: chat4all
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app: user-service
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from api-gateway
    - from:
        - podSelector:
            matchLabels:
              app: api-gateway
      ports:
        - protocol: TCP
          port: 8083
    
    # Allow from router-service
    - from:
        - podSelector:
            matchLabels:
              app: router-service
      ports:
        - protocol: TCP
          port: 8083
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53
    
    # Allow to PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432

---
# Allow File Service communication
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-file-service
  labels:
    app.kubernetes.io/platform: chat4all
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app: file-service
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from api-gateway
    - from:
        - podSelector:
            matchLabels:
              app: api-gateway
      ports:
        - protocol: TCP
          port: 8084
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53
    
    # Allow to MongoDB
    - to:
        - podSelector:
            matchLabels:
              app: mongodb
      ports:
        - protocol: TCP
          port: 27017
    
    # Allow to MinIO (S3)
    - to:
        - podSelector:
            matchLabels:
              app: minio
      ports:
        - protocol: TCP
          port: 9000

---
# Allow WhatsApp Connector communication
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-whatsapp-connector
  labels:
    app.kubernetes.io/platform: chat4all
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app: whatsapp-connector
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from router-service
    - from:
        - podSelector:
            matchLabels:
              app: router-service
      ports:
        - protocol: TCP
          port: 8091
    
    # Allow from api-gateway (for webhooks)
    - from:
        - podSelector:
            matchLabels:
              app: api-gateway
      ports:
        - protocol: TCP
          port: 8091
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53
    
    # Allow to Kafka
    - to:
        - podSelector:
            matchLabels:
              app: kafka
      ports:
        - protocol: TCP
          port: 9092
    
    # Allow to external WhatsApp API
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443

---
# Allow Telegram Connector communication
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-telegram-connector
  labels:
    app.kubernetes.io/platform: chat4all
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app: telegram-connector
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from router-service
    - from:
        - podSelector:
            matchLabels:
              app: router-service
      ports:
        - protocol: TCP
          port: 8092
    
    # Allow from api-gateway (for webhooks)
    - from:
        - podSelector:
            matchLabels:
              app: api-gateway
      ports:
        - protocol: TCP
          port: 8092
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53
    
    # Allow to Kafka
    - to:
        - podSelector:
            matchLabels:
              app: kafka
      ports:
        - protocol: TCP
          port: 9092
    
    # Allow to external Telegram API
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443

---
# Allow Instagram Connector communication
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-instagram-connector
  labels:
    app.kubernetes.io/platform: chat4all
    app.kubernetes.io/component: network-policy
spec:
  podSelector:
    matchLabels:
      app: instagram-connector
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from router-service
    - from:
        - podSelector:
            matchLabels:
              app: router-service
      ports:
        - protocol: TCP
          port: 8093
    
    # Allow from api-gateway (for webhooks)
    - from:
        - podSelector:
            matchLabels:
              app: api-gateway
      ports:
        - protocol: TCP
          port: 8093
  egress:
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53
    
    # Allow to Kafka
    - to:
        - podSelector:
            matchLabels:
              app: kafka
      ports:
        - protocol: TCP
          port: 9092
    
    # Allow to external Instagram API
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443
